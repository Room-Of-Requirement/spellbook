apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dashy
spec:
  interval: 1m
  chart:
    spec:
      # renovate: registryUrl=https://charts.jmmaloney4.xyz/
      chart: basic
      version: 0.2.5
      sourceRef:
        kind: HelmRepository
        name: jmmaloney4
        namespace: flux-system
      interval: 1m
  values:
      image:
        repository: ghcr.io/lissy93/dashy
        tag: 2.1.0@sha256:e11042764015f49dedf4d45ab83c7b01c1500b5591d513a4e80594f1939d8687
      ingress:
        main:
          enabled: true
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
            uroperator.brennerm.github.io/monitor.type: HTTPS
            nginx.ingress.kubernetes.io/auth-response-headers: Authorization
            nginx.ingress.kubernetes.io/auth-signin: https://$host/oauth2/start?rd=$escaped_request_uri
            nginx.ingress.kubernetes.io/auth-url: https://$host/oauth2/auth
            nginx.ingress.kubernetes.io/configuration-snippet: |
              auth_request_set $name_upstream_1 $upstream_cookie_name_1;
              access_by_lua_block {
                if ngx.var.name_upstream_1 ~= "" then
                  ngx.header["Set-Cookie"] = "name_1=" .. ngx.var.name_upstream_1 .. ngx.var.auth_cookie:match("(; .*)")
                end
              }
          hosts:
          - host: "secure.roomofrequirement.xyz"
            paths:
            - path: "/"
              service:
                name: dashy-basic
                port: 80
          tls:
          - secretName: secure-cert
            hosts:
            - secure.roomofrequirement.xyz
      service:
        main:
          enabled: true
          ports:
            http:
              enabled: true
              primary: true
              port: 80
      persistence:
        config:
          enabled: true
          type: configMap
          name: dashy-basic-config
          mountPath: /app/public/conf.yml
          subPath: conf.yml
      configmap:
        config:
          enabled: true
          data:
            conf.yml: |
              pageInfo:
                title: The Room of Requirement
                description: "\"It is a room that a person can only enter when they have real need of it.\""
                footerText: ""
              appConfig:
                theme: Vaporware
                disableConfiguration: true
                startingView: minimal
                defaultOpeningMethod: newtab

              