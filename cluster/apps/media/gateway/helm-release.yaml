apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gateway
  namespace: vpn
spec:
  interval: 1m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: pod-gateway
      version: 3.2.2
      sourceRef:
        kind: HelmRepository
        name: k8s-at-home
        namespace: flux-system
      interval: 1m
  values:
    controllerAnnotations:
      reloader.stakater.com/auto: "true"
    env:
      TZ: America/Chicago
    routed_namespaces:
    - media
    webhook:
      gatewayDefault: false
      gatewayAnnotation: gateway
    settings:
      VPN_INTERFACE: wg0
      VPN_BLOCK_OTHER_TRAFFIC: false
      # VPN_LOCAL_CIDRS: "10.0.0.0/8 192.168.0.0/16"

      # Calico Setup
      NOT_ROUTED_TO_GATEWAY_CIDRS: "172.22.0.0/12 192.168.0.0/16" # "172.22.0.0/12 <local home network CIDR>"
      VPN_LOCAL_CIDRS: "172.22.0.0/12 192.168.0.0/16" # "172.22.0.0/12 <local home network CIDR>"
      VXLAN_IP_NETWORK: "192.168.242.0/24"
    addons:
      vpn:
        enabled: true
        # This Should be set to `wireguard`. This will set the add-on to use the default settings for Wireguard based connections.
        type: wireguard
        wireguard:
          image:
            repository: ghcr.io/k8s-at-home/wireguard
            tag: v1.0.20210424@sha256:448045c4270b818ded47ec82b934e7227235402fbefa16e29800c2fb51d6de39
        # If the podSecurityContext is set to run as a different user, make sure to run the Wireguard container as UID/GID 568.
        # This is required for it to be able to read certain configuration files.
        securityContext:
          runAsUser: 568
          runAsGroup: 568
        networkPolicy:
          enabled: false
        env:
          TZ: America/Chicago
        configFileSecret:
        configFile: |
          [Interface]
          PrivateKey = ${MULLVAD_WIREGUARD_PRIVATE_KEY}
          Address = 10.65.71.69/32,fc00:bbbb:bbbb:bb01::2:4744/128
          DNS = 193.138.218.74
          PostUp = iptables -I OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT && ip6tables -I OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT
          PreDown = iptables -D OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT && ip6tables -D OUTPUT ! -o %i -m mark ! --mark $(wg show %i fwmark) -m addrtype ! --dst-type LOCAL -j REJECT

          [Peer]
          PublicKey = ${MULLVAD_WIREGUARD_PUBLIC_KEY}
          AllowedIPs = 0.0.0.0/0,::0/0
          Endpoint = 68.235.43.130:51820
